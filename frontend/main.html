<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
	<link rel="stylesheet" type="text/css" href="css/main.css" />
	<title>База игроков</title>
	<meta http-equiv="X-UA-Compatible" content="IE=8;charset=utf-8">
</head>
<body>
	<p>
		<form class="form">
			<table width="100%" style="table-layout: fixed">
				<colgroup>
					<col width="100px">
					<col width="100%">
					<col width="200px">
				</colgroup>

				<tr>
					<td class="info_block">
						<input type="button" name="info" value="Главная" onClick="MainPage()">
					</td>

					<td class = "search_block">
						<input type="text" name="search_field" id="search_field" class="search_field" placeholder="Поиск по никнейму, ip, hwid...">					
						<input type="button" name="search" id="search" value="Искать" onClick="Search(this.form)">
					</td>

					<td class= "user_block">
						<label class ="user_name" id="user_name">user</label>
						<input type="button" name="exit" value="Выйти" onClick="toLoginPage()">
					</td>
				</tr>
			</table> 		       
		</form>

		<p class = "results_cnt" id="results_cnt">
			Найдено игроков: 228
		</p>


<script language="javascript" type="text/javascript">

const searchKey = "search"
const pageKey = "page"
const urlParams = new URLSearchParams(window.location.search);
id = urlParams.get("id")
maxPage=1
curPage=1

var Load = function()
{
	// Если не вошли!!!
	if (id == null) 
	{
		toLoginPage();
	}

	// Добавить в url страницу и текст для поиска если их нет
	search = urlParams.get(searchKey)
	needToChangeUrl = false;

	if(search == null)
	{
		urlParams.append(searchKey,"")
		needToChangeUrl = true
	}

	curPage = urlParams.get(pageKey)

	if(curPage == null)
	{
		urlParams.append(pageKey,"1")
		needToChangeUrl = true
	}

	if(needToChangeUrl == true)
	{
		window.location.search = urlParams.toString()
		throw new Error()
	}

	// Установить имя пользователя
	nameRequest = "http://185.189.255.144:8080/PlayersSite/v1/MyName?key="+id;
	user = httpGet(nameRequest);	
	document.getElementById('user_name').innerHTML = user.responseText	
	
	searchReq = "http://185.189.255.144:8080/PlayersSite/v1/SearchPlayers?key="+id+"&search="+encodeURIComponent(search)+"&page="+curPage
	//alert(searchReq)
	M = httpGet(searchReq)
	

	//PrintS(M.responseText)	
	//PrintS(M.);

	var J = JSON.parse(M.responseText);
	
	//PrintJSON("res",J);
	CreatePlayersList(J);
	SetSeachOnPressEnter();	
}

function SetSeachOnPressEnter()
{
	var input = document.getElementById("search_field");
	input.addEventListener("keypress", function(event) 
	{
		if (event.key === "Enter") 
		{
			event.preventDefault();
			document.getElementById("search").click();
		}
	});
}

function CreatePlayersList(playersJSON) 
{
	const body = document.body, tbl = document.createElement('table');

	resultsCnt = playersJSON.resultsCnt
	document.getElementById('results_cnt').innerHTML = "Найдено игроков: " + resultsCnt

	pagesCnt = playersJSON.pagesCnt
	maxPage = pagesCnt	
	firstNumber = playersJSON.firstNumber

	tbl.style.width = '100%';
	tbl.style.border = '1px solid black';
	spaces = '\xa0\xa0\xa0\xa0\xa0\xa0\xa0';

	for (let i = 0; i < playersJSON.players.length; i++)
	{
		const tr = tbl.insertRow();
		const td = tr.insertCell();
		tr.id = playersJSON.players[i].playerId
		
		num = firstNumber+ i+1
		text = num + ". Ники: "

		for (let j = 0; j < playersJSON.players[i].nicknames.length; j++)
		{
			if (j != 0)
				text = text+ ","+spaces;

			text = text+ playersJSON.players[i].nicknames[j]
		}

		td.appendChild(document.createTextNode(text));
		var br = document.createElement("br");
		td.appendChild(br);
		var br = document.createElement("br");
		td.appendChild(br);		

		text="ip: ";

		for (let j = 0; j < playersJSON.players[i].addresses.length; j++)
		{
			if (j != 0)
				text = text+ ","+spaces;

			text = text+ playersJSON.players[i].addresses[j]
		}

		td.appendChild(document.createTextNode(text));
		var br = document.createElement("br");		
		td.appendChild(br);
		var br = document.createElement("br");		
		td.appendChild(br);

		text="hwid: " +playersJSON.players[i].hwid;
		td.appendChild(document.createTextNode(text));

		td.style.borderBottom = '1px solid black';
		td.style.padding = '10px'
		td.style.overflowWrap = 'anywhere'
		
		td2 = tr.insertCell();
		td2.className = "info_player"

		buttonInfo = document.createElement("input");
		buttonInfo.type = "button"
		buttonInfo.value ="Инфо"
		buttonInfo.className = "player_info_button"
		
		buttonInfo.onclick = function() 
		{			
			PlayerInfo(tr.id);
		};

		td2.appendChild(buttonInfo)

		//<input type="button" name="info" value="Главная" onClick="MainPage()">
	}

	body.appendChild(tbl);	
}

function httpGet(theUrl)
{
    var xmlHttp = new XMLHttpRequest({mozSystem: true});
    xmlHttp.open( "GET", theUrl, false ); // false for synchronous request
	//xmlHttp.setRequestHeader('Content-Type', 'application/json');
	//xmlHttp.getResponseHeader('Content-Type', 'application/json');
	//xmlHttp.responseType = 'json';
    xmlHttp.send();

	if(xmlHttp.responseText == "Unauthorized")
	{
		toLoginPage();
	}
	
    return xmlHttp;
}

function toLoginPage()
{
	loginPage = "login.html"
	location = loginPage;
	throw new Error();
}

function MainPage() 
{
	urlParams.set(searchKey,"")
	urlParams.set(pageKey,1)

	window.location.search = urlParams.toString()
	throw new Error()	
}

function Search(form)
{
	val = form.search_field.value
	urlParams.set(searchKey,val);
	urlParams.set(pageKey,"1");

	window.location.search = urlParams.toString()
	throw new Error()	
}

function ChangePage(form)
{
	val = form.page_input.value

	if(typeof(val) !="string" || isNaN(val) || isNaN(parseFloat(val)) || val < 1 || val > pagesCnt)
	{
		alert("Введена недопустимая страница!")
		return;
	}

	urlParams.set(pageKey,val);
	window.location.search = urlParams.toString()
	throw new Error()
}

function PrevPage(form)
{
	val = curPage
	val--

	if(val < 1 || val > pagesCnt)
	{
		return;
	}

	urlParams.set(pageKey,val);
	window.location.search = urlParams.toString()
	throw new Error()
}

function NextPage(form)
{
	val = curPage
	val++

	if(val < 1 || val > pagesCnt)
	{
		return;
	}

	urlParams.set(pageKey,val);
	window.location.search = urlParams.toString()
	throw new Error()
}

function PlayerInfo(PlayerId)
{
	//alert(PlayerId)
	infoPage = "info.html"
	idArg = "?id="+id+"&pl="+PlayerId
	location = infoPage+idArg;
}

function PrintS(s) { document.body.innerHTML += s; }
function PrintP(p) { document.body.innerHTML += "\<img src=\"data:image\/png;base64," + p + "\"\/\>";}
function PrintTIME(s,t1) { PrintS("<b><i>" + s + ": "+ (new Date().getTime()-t1.getTime())/1000 +"</i></b> sec.<br>") }
function PrintJSON (str,obj) { PrintS( str + ":<p>"      + unescape(JSON.stringify(obj).replace(/\\u/g, '%u').replace(/</g,"&lt;").replace(/>/g,"&gt;"))); }
function PrintJSONb(str,obj) { PrintS( str + ":<p><pre>" + unescape(JSON.stringify(obj,null,4).replace(/\\u/g, '%u').replace(/</g,"&lt;").replace(/>/g,"&gt;")) + "</pre>" ); }
function PrintXML(str,obj) { PrintS( str + ":<p>" + obj.replace(/</g,"&lt;").replace(/>/g,"&gt;") + "<br>" ); }

Load();

</script>

<p>
<form class="pageform">
	<input type="button" name="page_go_back" value="Предыдущая" onClick="PrevPage(this.form)">
	<label class ="page_label" id="page_label">Страница 228 из 2</label>
	<input type="text" name="page_input" class="page_input" placeholder="Введите номер страницы">					
	<input type="button" name="page_go" value="Перейти" onClick="ChangePage(this.form)">
	<input type="button" name="page_go_forward" value="Следующая" onClick="NextPage(this.form)">
</form>
</p>

<script language="javascript" type="text/javascript">
document.getElementById('page_label').innerHTML = "Страница "+curPage+" из "+ maxPage
</script>

</p></body></html>